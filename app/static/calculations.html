<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Calculations - Calculator App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
        }
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            transition: transform 0.2s;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            color: white;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }
        .operation-badge {
            font-size: 0.9rem;
            padding: 5px 10px;
        }
        #logoutBtn {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body>
    <button id="logoutBtn" class="btn btn-light">Logout</button>
    
    <div class="main-container">
        <div class="text-center text-white mb-4">
            <h1 class="display-4">My Calculations</h1>
            <p class="lead">Manage your calculation history</p>
            <p id="welcomeMessage" class="fs-5"></p>
        </div>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Add New Calculation Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Add New Calculation</h5>
            </div>
            <div class="card-body">
                <form id="addCalculationForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="operandA" class="form-label">First Number (a)</label>
                            <input type="number" step="any" class="form-control" id="operandA" required>
                        </div>
                        <div class="col-md-3">
                            <label for="operationType" class="form-label">Operation</label>
                            <select class="form-select" id="operationType" required>
                                <option value="Add">Add (+)</option>
                                <option value="Subtract">Subtract (-)</option>
                                <option value="Multiply">Multiply (×)</option>
                                <option value="Divide">Divide (÷)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="operandB" class="form-label">Second Number (b)</label>
                            <input type="number" step="any" class="form-control" id="operandB" required>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-custom w-100">Calculate & Save</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Calculations Table Card -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Calculation History</h5>
                <button class="btn btn-light btn-sm" onclick="loadCalculations()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                    Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>First Number</th>
                                <th>Operation</th>
                                <th>Second Number</th>
                                <th>Result</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="calculationsTableBody">
                            <tr>
                                <td colspan="7" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Calculation</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCalculationForm">
                        <input type="hidden" id="editCalculationId">
                        <div class="mb-3">
                            <label for="editOperandA" class="form-label">First Number (a)</label>
                            <input type="number" step="any" class="form-control" id="editOperandA" required>
                        </div>
                        <div class="mb-3">
                            <label for="editOperationType" class="form-label">Operation</label>
                            <select class="form-select" id="editOperationType" required>
                                <option value="Add">Add (+)</option>
                                <option value="Subtract">Subtract (-)</option>
                                <option value="Multiply">Multiply (×)</option>
                                <option value="Divide">Divide (÷)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editOperandB" class="form-label">Second Number (b)</label>
                            <input type="number" step="any" class="form-control" id="editOperandB" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-custom">Update Calculation</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = '';
        let authToken = localStorage.getItem('token');
        let currentUsername = localStorage.getItem('username');

        // Check if user is logged in
        if (!authToken) {
            console.log("No auth token found, redirecting to login");
            window.location.href = '/static/login.html';
        }

        // Display welcome message
        if (currentUsername) {
            document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUsername}!`;
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = '/static/login.html';
        });

        // Show alert messages
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // Load calculations from API
        async function loadCalculations() {
            try {
                const response = await fetch(`${API_BASE_URL}/calculations/`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/static/login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load calculations');
                }

                const calculations = await response.json();
                displayCalculations(calculations);
            } catch (error) {
                showAlert(`Error loading calculations: ${error.message}`, 'danger');
                document.getElementById('calculationsTableBody').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">Error loading calculations</td></tr>';
            }
        }

        // Display calculations in table
        function displayCalculations(calculations) {
            const tbody = document.getElementById('calculationsTableBody');
            
            if (calculations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No calculations yet. Create your first one above!</td></tr>';
                return;
            }

            tbody.innerHTML = calculations.map(calc => {
                const operationSymbol = {
                    'Add': '+',
                    'Subtract': '-',
                    'Multiply': '×',
                    'Divide': '÷'
                }[calc.type];

                const badgeClass = {
                    'Add': 'bg-success',
                    'Subtract': 'bg-warning',
                    'Multiply': 'bg-info',
                    'Divide': 'bg-primary'
                }[calc.type];

                const createdAt = new Date(calc.created_at).toLocaleString();

                return `
                    <tr>
                        <td>${calc.id}</td>
                        <td>${calc.a}</td>
                        <td><span class="badge ${badgeClass} operation-badge">${operationSymbol} ${calc.type}</span></td>
                        <td>${calc.b}</td>
                        <td><strong>${calc.result}</strong></td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editCalculation(${calc.id})">Edit</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCalculation(${calc.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Add new calculation
        document.getElementById('addCalculationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const a = parseFloat(document.getElementById('operandA').value);
            const b = parseFloat(document.getElementById('operandB').value);
            const type = document.getElementById('operationType').value;

            // Client-side validation for division by zero
            if (type === 'Divide' && b === 0) {
                showAlert('Division by zero is not allowed!', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/calculations/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ a, b, type })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create calculation');
                }

                const newCalc = await response.json();
                showAlert(`Calculation created successfully! Result: ${newCalc.result}`, 'success');
                
                // Reset form
                document.getElementById('addCalculationForm').reset();
                
                // Reload calculations
                loadCalculations();
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'danger');
            }
        });

        // Edit calculation
        async function editCalculation(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/calculations/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load calculation');
                }

                const calc = await response.json();
                
                // Populate edit form
                document.getElementById('editCalculationId').value = calc.id;
                document.getElementById('editOperandA').value = calc.a;
                document.getElementById('editOperandB').value = calc.b;
                document.getElementById('editOperationType').value = calc.type;

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'danger');
            }
        }

        // Update calculation
        document.getElementById('editCalculationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editCalculationId').value;
            const a = parseFloat(document.getElementById('editOperandA').value);
            const b = parseFloat(document.getElementById('editOperandB').value);
            const type = document.getElementById('editOperationType').value;

            // Client-side validation for division by zero
            if (type === 'Divide' && b === 0) {
                showAlert('Division by zero is not allowed!', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/calculations/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ a, b, type })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update calculation');
                }

                const updatedCalc = await response.json();
                showAlert(`Calculation updated successfully! New result: ${updatedCalc.result}`, 'success');
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                modal.hide();
                
                // Reload calculations
                loadCalculations();
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'danger');
            }
        });

        // Delete calculation
        async function deleteCalculation(id) {
            if (!confirm('Are you sure you want to delete this calculation?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/calculations/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete calculation');
                }

                showAlert('Calculation deleted successfully!', 'success');
                loadCalculations();
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'danger');
            }
        }

        // Load calculations on page load
        loadCalculations();
    </script>
</body>
</html>
